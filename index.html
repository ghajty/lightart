<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>貓貓燈具</title>
<style>
html, body {margin:0; padding:0; font-family:Arial,sans-serif; background:#f5f5f5; color:#333; min-height:100dvh; padding-top:env(safe-area-inset-top,0px);}
body {box-sizing:border-box;}
header {position:fixed; top:0; left:0; width:100%; background:#fff; display:flex; align-items:center; padding:10px 20px; border-bottom:1px solid #ddd; z-index:1000; box-shadow:0 1px 5px rgba(0,0,0,0.1);}
header img{width:50px;height:50px;border-radius:50%;}
header h1{margin:0 10px; font-size:1.8em;}
header .top-buttons{display:flex; gap:5px; margin-left:20px;}
header .top-buttons button{padding:5px 10px; border:none; border-radius:5px; background:#333; color:#fff; cursor:pointer; font-size:0.9em;}
header .top-buttons button:hover{background:#555;}
.container {max-width:1000px; margin:0 auto; padding:20px; padding-top: calc(80px + env(safe-area-inset-top, 0px));}
.side-panel {position:fixed; right:0; width:320px; height:100dvh; background:#fff; border-left:1px solid #ddd; z-index:950; display:none; box-shadow:-2px 0 10px rgba(0,0,0,0.1); overflow:hidden; top: calc(80px + env(safe-area-inset-top, 0px)); height: calc(100dvh - 80px - env(safe-area-inset-top, 0px));}
.cart-header {position:sticky; top:0; background:#fff; padding:15px 20px; border-bottom:1px solid #eee; z-index:10; font-weight:bold;}
.cart-content {height:100%; overflow-y:auto; padding:15px 20px; -webkit-overflow-scrolling:touch;}
.cart-item {margin-bottom:12px; padding:10px; background:#f8f8f8; border-radius:8px;}
.cart-item button {width:28px; height:28px; padding:0; margin:0 2px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer;}
.cart-item button[data-action="del"] {color:#e74c3c; width:auto; padding:0 6px;}
.side-panel > h2 {margin:0 0 15px; padding:20px 20px 0; font-size:1.2em;}
.side-panel > p, .side-panel > ul {padding:0 20px;}
.side-panel button:not(#cartCloseBtn) {margin:15px 20px 0; padding:8px 12px; width:calc(100% - 40px); background:#333; color:#fff; border:none; border-radius:5px; cursor:pointer; position:relative; z-index:1001;}
.side-panel button:not(#cartCloseBtn):hover {background:#555;}
#categoryToggle{cursor:pointer; background:#333; color:#fff; padding:8px; border-radius:5px; width:140px; text-align:center; margin:10px 0;}
#categoryToggle:hover{background:#555;}
#categoryList{display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px; display:none;}
#categoryList button{padding:5px 10px; background:#666; border:none; color:#fff; border-radius:5px; cursor:pointer; font-size:0.9em;}
#categoryList button.active{background:#333;}
#categoryList button:hover{background:#555;}
.products{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:20px;}
.product-card{background:#fff; border-radius:10px; padding:15px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.product-card img{width:100%; height:180px; object-fit:cover; border-radius:5px;}
.product-card h3{margin:10px 0 5px;}
.product-card p{margin:0 0 10px;}
.product-card button{padding:5px 10px; margin:2px; background:#333; border:none; border-radius:5px; color:#fff; cursor:pointer;}
.product-card button:hover{background:#555;}
form{background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #ddd;}
form input, form select{width:100%; padding:8px; margin:5px 0 10px; border-radius:5px; border:1px solid #ccc;}
form button{width:100%; padding:10px; background:#333; border:none; border-radius:5px; font-weight:bold; color:#fff; cursor:pointer;}
form button:hover{background:#555;}
#cartToggleBtn, #logoutBtn{margin:10px 0; padding:5px 10px; border:none; border-radius:5px; background:#333; color:#fff; cursor:pointer;}
#cartToggleBtn:hover, #logoutBtn:hover{background:#555;}
#memberArea{margin-bottom:10px;}
#welcomeMsg{font-weight:bold; color:#333;}
#historyListSide{list-style:none; padding:0; margin:0;}
#historyListSide li{margin:10px 0; padding:12px; background:#f0f0f0; border-radius:8px; font-size:0.95em;}
.overlay{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:900;}
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; flex:1;">
    <img src="https://placekitten.com/50/50" alt="公司頭貼">
    <h1>貓貓燈具</h1>
    <div class="top-buttons">
      <button id="introBtn">公司簡介</button>
      <button id="historyBtn">交易歷史</button>
      <button id="contactBtn">客服</button>
    </div>
  </div>
</header>

<div class="container">
  <div id="memberArea">
    <span id="welcomeMsg"></span>
    <button id="logoutBtn" style="display:none;">登出</button>
  </div>
  <button id="cartToggleBtn" style="display:none;">開啟購物車</button>
  <div id="categoryToggle">顯示分類 ▼</div>
  <div id="categoryList"></div>
  <div class="products" id="productList"></div>
  <form id="memberForm">
    <h2>會員系統</h2>
    <input type="text" id="memberUsername" placeholder="帳號" required>
    <input type="password" id="memberPassword" placeholder="密碼" required>
    <input type="email" id="memberEmail" placeholder="Email (註冊用)">
    <button type="submit">註冊 / 登入</button>
  </form>
</div>

<div id="introSide" class="side-panel"><h2>公司簡介</h2><p>貓貓燈具專注於提供各式吊燈、壁燈、吸頂燈、投射燈、燈條與軌道燈，結合設計美感與功能性，為每個空間帶來光與溫度。</p><button id="closeIntroBtn">關閉</button></div>
<div id="historySide" class="side-panel"><h2>歷史訂單</h2><ul id="historyListSide"></ul><button id="closeHistoryBtn">關閉</button></div>
<div id="contactSide" class="side-panel"><h2>客服聯絡方式</h2><p>Email: support@catlamp.com</p><p>LINE: @catlamp</p><p>電話: 02-1234-5678</p><button id="closeContactBtn">關閉</button></div>
<div id="checkoutSide" class="side-panel"></div>
<div id="modalOverlay" class="overlay"></div>

<script>
// === 全域變數 ===
let cart = JSON.parse(localStorage.getItem('catlamp_cart')) || [];
let currentMember = JSON.parse(localStorage.getItem('catlamp_member')) || null;
let orderHistory = JSON.parse(localStorage.getItem('catlamp_history')) || [];

// === DOM 元素 ===
const elements = {};
document.addEventListener('DOMContentLoaded', () => {
  elements.productList = document.getElementById("productList");
  elements.categoryList = document.getElementById("categoryList");
  elements.cartToggleBtn = document.getElementById("cartToggleBtn");
  elements.checkoutSide = document.getElementById("checkoutSide");
  elements.modalOverlay = document.getElementById("modalOverlay");
  elements.introBtn = document.getElementById("introBtn");
  elements.historyBtn = document.getElementById("historyBtn");
  elements.contactBtn = document.getElementById("contactBtn");
  elements.introSide = document.getElementById("introSide");
  elements.historySide = document.getElementById("historySide");
  elements.contactSide = document.getElementById("contactSide");
  elements.welcomeMsg = document.getElementById("welcomeMsg");
  elements.logoutBtn = document.getElementById("logoutBtn");
  elements.memberForm = document.getElementById("memberForm");
  elements.historyListSide = document.getElementById("historyListSide");
  elements.categoryToggle = document.getElementById("categoryToggle");

  // 初始化
  updateCartButton();
  updateMemberUI();
  initEvents();
});

function initEvents() {
  // 頂部按鈕
  elements.introBtn.onclick = () => openPanel(elements.introSide);
  elements.historyBtn.onclick = () => openPanel(elements.historySide);
  elements.contactBtn.onclick = () => openPanel(elements.contactSide);
  elements.cartToggleBtn.onclick = openCart;

  // 關閉按鈕
  document.getElementById('closeIntroBtn').onclick = closeAllPanels;
  document.getElementById('closeHistoryBtn').onclick = closeAllPanels;
  document.getElementById('closeContactBtn').onclick = closeAllPanels;
  elements.modalOverlay.onclick = closeAllPanels;

  // 分類切換
  elements.categoryToggle.onclick = () => {
    const list = elements.categoryList;
    const isFlex = list.style.display === 'flex';
    list.style.display = isFlex ? 'none' : 'flex';
    elements.categoryToggle.textContent = isFlex ? '顯示分類 ▼' : '隱藏分類 ▲';
  };

  // 會員表單
  elements.memberForm.onsubmit = (e) => {
    e.preventDefault();
    const username = document.getElementById('memberUsername').value.trim();
    const password = document.getElementById('memberPassword').value;
    const email = document.getElementById('memberEmail').value.trim();

    if (!username || !password) return alert('請輸入帳號和密碼！');

    const members = JSON.parse(localStorage.getItem('catlamp_members') || '[]');
    const exist = members.find(m => m.username === username);

    if (exist) {
      if (exist.password !== password) return alert('密碼錯誤！');
      currentMember = { username, email: exist.email };
      alert('登入成功！');
    } else {
      if (!email) return alert('註冊需填寫 Email！');
      members.push({ username, password, email });
      localStorage.setItem('catlamp_members', JSON.stringify(members));
      currentMember = { username, email };
      alert('註冊成功！');
    }

    localStorage.setItem('catlamp_member', JSON.stringify(currentMember));
    updateMemberUI();
  };

  elements.logoutBtn.onclick = () => {
    currentMember = null;
    localStorage.removeItem('catlamp_member');
    updateMemberUI();
  };
}

// === 面板控制 ===
function openPanel(panel) {
  closeAllPanels();
  panel.style.display = "block";
  elements.modalOverlay.style.display = "block";
}
function closeAllPanels() {
  document.querySelectorAll('.side-panel').forEach(p => p.style.display = 'none');
  elements.modalOverlay.style.display = 'none';
}

// === 購物車 ===
function renderCart() {
  const side = elements.checkoutSide;
  side.innerHTML = '';
  const header = document.createElement('div');
  header.className = 'cart-header';
  header.innerHTML = `<div style="display:flex; justify-content:space-between;"><span>購物車 (${cart.length})</span><button id="cartCloseBtn" style="background:none;border:none;font-size:1.5em;cursor:pointer;color:#999;">×</button></div>`;
  side.appendChild(header);

  const content = document.createElement('div');
  content.className = 'cart-content';

  if (cart.length === 0) {
    content.innerHTML = "<p style='text-align:center; color:#999; margin:20px 0;'>購物車空空如也</p>";
  } else {
    const total = cart.reduce((s,c) => s + c.price * c.qty, 0);
    cart.forEach((c, i) => {
      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <div style="font-weight:500; margin-bottom:5px;">${c.name}</div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>$${c.price} × ${c.qty} = $${c.price * c.qty}</span>
          <div>
            <button data-action="dec" data-index="${i}">-</button>
            <span style="margin:0 8px; font-weight:bold;">${c.qty}</span>
            <button data-action="inc" data-index="${i}">+</button>
            <button data-action="del" data-index="${i}">刪除</button>
          </div>
        </div>
      `;
      content.appendChild(div);
    });
    const totalDiv = document.createElement("div");
    totalDiv.style.cssText = "margin:20px 0 15px; padding-top:15px; border-top:2px solid #eee; font-size:1.1em; font-weight:bold; display:flex; justify-content:space-between;";
    totalDiv.innerHTML = `<span>總計：$${total}</span><button id="checkoutBtn" style="padding:10px 16px; background:#e74c3c; color:white; border:none; border-radius:6px;">結帳</button>`;
    content.appendChild(totalDiv);
  }
  side.appendChild(content);

  header.querySelector('#cartCloseBtn').onclick = closeAllPanels;
  side.onclick = (e) => {
    const btn = e.target;
    const i = parseInt(btn.dataset.index);
    if (isNaN(i)) return;
    if (btn.dataset.action === 'dec') changeQty(i, -1);
    if (btn.dataset.action === 'inc') changeQty(i, 1);
    if (btn.dataset.action === 'del') removeItem(i);
  };
  const checkoutBtn = content.querySelector('#checkoutBtn');
  if (checkoutBtn) checkoutBtn.onclick = doCheckout;
}

function openCart() {
  renderCart();
  elements.checkoutSide.style.display = "block";
  elements.modalOverlay.style.display = "block";
}

function updateCartButton() {
  elements.cartToggleBtn.style.display = cart.length > 0 ? "inline-block" : "none";
}
function updateMemberUI() {
  if (currentMember) {
    elements.welcomeMsg.textContent = `歡迎，${currentMember.username}！`;
    elements.logoutBtn.style.display = "inline-block";
    elements.memberForm.style.display = "none";
  } else {
    elements.welcomeMsg.textContent = "";
    elements.logoutBtn.style.display = "none";
    elements.memberForm.style.display = "block";
  }
  renderHistory();
}
function renderHistory() {
  elements.historyListSide.innerHTML = "";
  const userOrders = currentMember ? orderHistory.filter(o => o.member === currentMember.username) : [];
  if (userOrders.length === 0) {
    elements.historyListSide.innerHTML = "<li style='color:#999; text-align:center; padding:20px;'>尚無訂單紀錄</li>";
  } else {
    userOrders.forEach(order => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${order.date}</strong><br>訂單編號: ${order.id}<br>總金額: $${order.total}<br><small>${order.items.map(i=>`${i.name} x${i.qty}`).join(', ')}</small>`;
      elements.historyListSide.appendChild(li);
    });
  }
}
function changeQty(i, d) { cart[i].qty = Math.max(1, cart[i].qty + d); saveCart(); renderCart(); }
function removeItem(i) { cart.splice(i, 1); saveCart(); updateCartButton(); renderCart(); }
function doCheckout() {
  if (!currentMember) return alert("請先登入！");
  const order = { id: Date.now(), date: new Date().toLocaleString('zh-TW'), items: [...cart], total: cart.reduce((s,c)=>s+c.price*c.qty,0), member: currentMember.username };
  orderHistory.push(order);
  localStorage.setItem('catlamp_history', JSON.stringify(orderHistory));
  cart = []; saveCart(); updateCartButton(); renderHistory(); closeAllPanels(); alert("訂單已送出！");
}
function saveCart() { localStorage.setItem('catlamp_cart', JSON.stringify(cart)); }

// === 外部載入產品 ===
</script>

<script src="load-products.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof renderCategories === 'function') renderCategories();
    if (typeof displayProducts === 'function') displayProducts();
  });
</script>

</body>
</html>
